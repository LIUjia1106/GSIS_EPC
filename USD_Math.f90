!factorial
REAL*8 FUNCTION FAC(N)
IMPLICIT NONE
INTEGER, INTENT(IN) :: N
INTEGER :: I
REAL*8 :: ANS

ANS = 1.d0
DO I = 1, N
  ANS = ANS*REAL(I,8)
END DO
FAC=ANS

RETURN
END FUNCTION FAC

REAL*8 FUNCTION FAC_CUT(Ns,Ne)
IMPLICIT NONE
INTEGER, INTENT(IN) :: Ns, Ne
INTEGER :: I
REAL*8 :: ANS

ANS = 1.d0
DO I = Ns, Ne
  ANS = ANS*REAL(I,8)
END DO
FAC_CUT=ANS

RETURN
END FUNCTION FAC_CUT

REAL*8 FUNCTION FAC_DIV(Ns,Ne,Ds,De)
IMPLICIT NONE
INTEGER, INTENT(IN) :: Ns, Ne, Ds, De
INTEGER :: NUMn, NUMd, I
REAL*8 :: ANS

NUMn = Ne - Ns + 1
NUMd = De - Ds + 1

ANS = 1.d0
DO I = 1, MIN(NUMn,NUMd)
  ANS = ANS*REAL(Ns+I-1,8)/REAL(Ds+I-1,8)
END DO
IF (NUMn.GT.NUMd) THEN
  DO I = NUMd+1, NUMn
    ANS = ANS*REAL(Ns+I-1,8)
  END DO
END IF
IF (NUMd.GT.NUMn) THEN
  DO I = NUMn+1, NUMd
    ANS = ANS/REAL(Ds+I-1,8)
  END DO
END IF

FAC_DIV = ANS

RETURN
END FUNCTION FAC_DIV

MODULE USER_DEFINE_MATH
USE CONSTANT

CONTAINS

  SUBROUTINE TRI_QUADRATURE (ABSCISSA_X,ABSCISSA_Y,WEIGHT,NP)
  IMPLICIT NONE
  INTEGER, INTENT(IN) :: NP
  REAL (KIND=DBL), INTENT(OUT),DIMENSION(NP):: ABSCISSA_X,ABSCISSA_Y,WEIGHT
  REAL (KIND=DBL) :: a,b

  SELECT CASE (NP)
  CASE (3)

    WEIGHT = 1.d0/3.d0

    ABSCISSA_X(1) = 0.5d0
    ABSCISSA_Y(1) = 0.d0

    ABSCISSA_X(2) = 0.5d0
    ABSCISSA_Y(2) = 0.5d0

    ABSCISSA_X(3) = 0.d0
    ABSCISSA_Y(3) = 0.5d0

  CASE (4)

    WEIGHT(1) = -27.d0/48.d0
    WEIGHT(2:4) = 25.d0/48.d0

    ABSCISSA_X(1) = 1.d0/3.d0
    ABSCISSA_Y(1) = 1.d0/3.d0

    ABSCISSA_X(2) = 0.2d0
    ABSCISSA_Y(2) = 0.2d0

    ABSCISSA_X(3) = 0.6d0
    ABSCISSA_Y(3) = 0.2d0

    ABSCISSA_X(4) = 0.2d0
    ABSCISSA_Y(4) = 0.6d0

  CASE (6)

    WEIGHT(1:3) = 0.109951743655322d0
    WEIGHT(4:6) = 0.223381589678011d0

    ABSCISSA_X(1) = 0.091576213509771d0
    ABSCISSA_Y(1) = 0.091576213509771d0

    ABSCISSA_X(2) = 0.816847572980459d0
    ABSCISSA_Y(2) = 0.091576213509771d0

    ABSCISSA_X(3) = 0.091576213509771d0
    ABSCISSA_Y(3) = 0.816847572980459d0

    ABSCISSA_X(4) = 0.445948490915965d0
    ABSCISSA_Y(4) = 0.445948490915965d0

    ABSCISSA_X(5) = 0.108103018168070d0
    ABSCISSA_Y(5) = 0.445948490915965d0

    ABSCISSA_X(6) = 0.445948490915965d0
    ABSCISSA_Y(6) = 0.108103018168070d0

  CASE (7)
    WEIGHT(1) = 0.225d0
    WEIGHT(2:4) = 0.125939180544827d0
    WEIGHT(5:7) = 0.132394152788506d0

    ABSCISSA_X(1) = 1.d0/3.d0
    ABSCISSA_Y(1) = 1.d0/3.d0

    ABSCISSA_X(2) = 0.101286507323456d0
    ABSCISSA_Y(2) = 0.101286507323456d0

    ABSCISSA_X(3) = 0.797426985353087d0
    ABSCISSA_Y(3) = 0.101286507323456d0

    ABSCISSA_X(4) = 0.101286507323456d0
    ABSCISSA_Y(4) = 0.797426985353087d0

    ABSCISSA_X(5) = 0.470142064105115d0
    ABSCISSA_Y(5) = 0.059715871789770d0

    ABSCISSA_X(6) = 0.470142064105115d0
    ABSCISSA_Y(6) = 0.470142064105115d0

    ABSCISSA_X(7) = 0.059715871789770d0
    ABSCISSA_Y(7) = 0.470142064105115d0

  CASE (12)
    WEIGHT(1:3) = 0.050844906370207d0
    WEIGHT(4:6) = 0.116786275726379d0
    WEIGHT(7:12) = 0.082851075618374d0

    a = 0.063089014491502d0
    ABSCISSA_X(1) = a
    ABSCISSA_Y(1) = 1.d0-2.d0*a

    ABSCISSA_X(2) = a
    ABSCISSA_Y(2) = a

    ABSCISSA_X(3) = 1.d0-2.d0*a
    ABSCISSA_Y(3) = a

    a = 0.249286745170911d0
    ABSCISSA_X(4) = a
    ABSCISSA_Y(4) = 1.d0-2.d0*a

    ABSCISSA_X(5) = a
    ABSCISSA_Y(5) = a

    ABSCISSA_X(6) = 1.d0-2.d0*a
    ABSCISSA_Y(6) = a

    a = 0.636502499121399d0
    b = 0.310352451033785d0
    ABSCISSA_X(7) = b
    ABSCISSA_Y(7) = 1.d0-a-b

    ABSCISSA_X(8) = 1.d0-a-b
    ABSCISSA_Y(8) = b

    ABSCISSA_X(9) = a
    ABSCISSA_Y(9) = b

    ABSCISSA_X(10) = b
    ABSCISSA_Y(10) = a

    ABSCISSA_X(11) = 1.d0-a-b
    ABSCISSA_Y(11) = a

    ABSCISSA_X(12) = a
    ABSCISSA_Y(12) = 1.d0-a-b

  CASE(16)
    WEIGHT(1) = 0.144315607677787d0
    WEIGHT(2:4) = 0.103217370534718d0
    WEIGHT(5:7) = 0.032458497623198d0
    WEIGHT(8:10) = 0.095091634267285d0
    WEIGHT(11:16) = 0.027230314174435d0

    ABSCISSA_X(1) = 1.d0/3.d0
    ABSCISSA_Y(1) = 1.d0/3.d0

    a = 0.170569307751760d0
    ABSCISSA_X(2) = a
    ABSCISSA_Y(2) = 1.d0-2.d0*a

    ABSCISSA_X(3) = a
    ABSCISSA_Y(3) = a

    ABSCISSA_X(4) = 1.d0-2.d0*a
    ABSCISSA_Y(4) = a

    a = 0.050547228317031d0
    ABSCISSA_X(5) = a
    ABSCISSA_Y(5) = 1.d0-2.d0*a

    ABSCISSA_X(6) = a
    ABSCISSA_Y(6) = a

    ABSCISSA_X(7) = 1.d0-2.d0*a
    ABSCISSA_Y(7) = a

    a = 0.459292588292723d0
    ABSCISSA_X(8) = a
    ABSCISSA_Y(8) = 1.d0-2.d0*a

    ABSCISSA_X(9) = a
    ABSCISSA_Y(9) = a

    ABSCISSA_X(10) = 1.d0-2.d0*a
    ABSCISSA_Y(10) = a

    a = 0.263112829634638d0
    b = 0.008394777409958d0
    ABSCISSA_X(11) = b
    ABSCISSA_Y(11) = 1.d0-a-b

    ABSCISSA_X(12) = 1.d0-a-b
    ABSCISSA_Y(12) = b

    ABSCISSA_X(13) = a
    ABSCISSA_Y(13) = b

    ABSCISSA_X(14) = b
    ABSCISSA_Y(14) = a

    ABSCISSA_X(15) = 1.d0-a-b
    ABSCISSA_Y(15) = a

    ABSCISSA_X(16) = a
    ABSCISSA_Y(16) = 1.d0-a-b

  END SELECT

  END SUBROUTINE TRI_QUADRATURE

	SUBROUTINE GaussHermit(VEL,WEIGHT,NC)
	IMPLICIT NONE
	INTEGER, INTENT(IN) :: NC
	REAL(KIND=DBL),INTENT(OUT),DIMENSION(NC)::VEL,WEIGHT
	INTEGER :: I

	SELECT CASE (NC)
	CASE (4)

		VEL(NC/2+1)=sqrt(3.d0-sqrt(6.d0))/sqrt(2.d0);
    	VEL(NC/2+2)=sqrt(3.d0+sqrt(6.d0))/sqrt(2.d0);

    	WEIGHT(NC/2+1)=(3.d0+sqrt(6.d0))/12.d0
    	WEIGHT(NC/2+2)=(3.d0-sqrt(6.d0))/12.d0

    	DO I = 1,NC/2
    		VEL(I)=-VEL(NC/2+I)
    		WEIGHT(I)=WEIGHT(NC/2+I)
    	END DO

	CASE (8)
		VEL=(/-2.262664477010366d0, &
              -1.342537825644997d0, &
              -6.243246901871937d-1, &
              -1.337764469960691d-1, &
               1.337764469960691d-1, &
               6.243246901871937d-1, &
               1.342537825644997d0, &
               2.262664477010366d0/)
		WEIGHT=(/1.066277085577627d0, &
                 8.092262056543287d-1, &
                 6.218311039474493d-1, &
                 3.311770718857950d-1, &
                 3.311770718857950d-1, &
                 6.218311039474493d-1, &
                 8.092262056543287d-1, &
                 1.066277085577627d0/)

	CASE (16)
		VEL=(/-3.686007162800335d0, &
       		  -2.863133883787330d0, &
       		  -2.183921153176019d0, &
       		  -1.588855862347645d0, &
       		  -1.064246312185799d0, &
       		  -6.163028842362114d-1, &
       		  -2.673983721980545d-1, &
       		  -5.297864393903579d-2, &
       		   5.297864393903579d-2, &
       		   2.673983721980545d-1, &
       		   6.163028842362114d-1, &
       		   1.064246312185799d0, &
       		   1.588855862347645d0, &
       		   2.183921153176019d0, &
       		   2.863133883787330d0, &
       		   3.686007162800335d0/)

		WEIGHT=(/9.486375006696570d-1, &
              7.338928958716250d-1, &
              6.326738437304906d-1, &
              5.594678110306394d-1, &
              4.886845810827102d-1, &
              4.034535037362057d-1, &
              2.882194783684150d-1, &
              1.344861263888033d-1, &
              1.344861263888033d-1, &
              2.882194783684150d-1, &
              4.034535037362057d-1, &
              4.886845810827102d-1, &
              5.594678110306394d-1, &
              6.326738437304906d-1, &
              7.338928958716250d-1, &
              9.486375006696570d-1/)

	CASE (24)
    VEL(1:12) = (/-6.015925561425735, &
  -5.259382927668045, &
  -4.625662756423786, &
  -4.053664402448152, &
  -3.520006813034525, &
  -3.012546137565564, &
  -2.523881017011428, &
  -2.049003573661701, &
  -1.584250010961694, &
  -1.126760817611244, &
  -0.674171107037212, &
  -0.224414547472515/)

    WEIGHT(1:12)=(/0.868875565091643, &
   0.678574662290107, &
   0.597391700440046, &
   0.550207547397848, &
   0.519043867583031, &
   0.497076692865753, &
   0.481072202833054, &
   0.469284885626491, &
   0.460693909629746, &
   0.454675477135120, &
   0.450846100819996, &
   0.448982845326226/)

    VEL(13:24) = -VEL(12:1:-1)
    WEIGHT(13:24) = WEIGHT(12:1:-1)

  CASE (28)
		VEL(15:28)=(/2.396724757843284d-2, 1.242911568927177d-1,  2.974477691473801d-1,  5.334998891822554d-1, &
			         8.220981923307155d-1, 1.154334829676328d0,  1.523573280902749d0,   1.925656879418240d0,  &
			         2.358931078010347d0,    2.824429077761555d0, 3.326604606373028d0,  3.875436187413726d0,  &
			         4.492761858309454d0,  5.238744144080820d0/)

		WEIGHT(15:28)=(/6.123724869886580d-2, 1.361115667521515d-1,  1.889014205320117d-1,  1.985861257727940d-1, &
						1.585835386099182d-1, 9.276908911579565d-2, 3.789962589474001d-2,  1.024419454744042d-2, &
						1.720120272586066d-3,  1.656430867082354d-4, &
                        8.177599975023724d-6, 1.734291294554730d-7,  1.139604105901161d-9,  1.037777563554779d-12/)
		DO I = 1,NC/2
    		VEL(I)=-VEL(NC/2+I)
    		WEIGHT(I)=WEIGHT(NC/2+I)
    	END DO

	END SELECT

  END SUBROUTINE

  !fftshift3d
  SUBROUTINE fftshift3d (N1,N2,N3,SPEC)
  IMPLICIT NONE
  INTEGER, INTENT(IN) :: N1, N2, N3
  COMPLEX (KIND=DBL), INTENT(INOUT), DIMENSION(N1,N2,N3) :: SPEC
  INTEGER :: I,J,K,JJ,KK
  COMPLEX (KIND=DBL) :: ss

  DO K = 1, N3
    IF (K.LE.N3/2) THEN
      KK = K + N3/2
    ELSE
      KK = K - N3/2
    END IF
    DO J = 1, N2
      IF (J.LE.N2/2) THEN
        JJ = J + N2/2
      ELSE
        JJ = J - N2/2
      END IF
      DO I = 1, N1/2
        ss = SPEC(I,J,K)
        SPEC(I,J,K) = SPEC(I + N1/2, JJ, KK)
        SPEC(I+N1/2,JJ,KK) = ss
      END DO
    END DO
  END DO

  RETURN
  END SUBROUTINE

  SUBROUTINE fftshift1d (N,SPEC)
  IMPLICIT NONE
  INTEGER, INTENT(IN) :: N
  COMPLEX (KIND=DBL), INTENT(INOUT), DIMENSION(N) :: SPEC
  COMPLEX (KIND=DBL) :: ss
  INTEGER :: I

  DO I = 1, N/2
    ss = SPEC(I)
    SPEC(I) = SPEC(I+N/2)
    SPEC(I+N/2) = ss
  END DO

  RETURN
  END SUBROUTINE

  !Computing the abscissas and weight of Gauss-Legendre quadrature on an interval [a,b]
  SUBROUTINE GaussLegendre (N,a,b,ABSC,WEIG)
  IMPLICIT NONE
  INTEGER, INTENT(IN) :: N
  REAL (KIND=DBL), INTENT (IN) :: a,b
  REAL (KIND=DBL), INTENT(OUT), DIMENSION(N) :: ABSC,WEIG
  INTEGER :: N1, N2, I, K
  REAL (KIND=DBL), ALLOCATABLE, DIMENSION(:) :: y, y0, Lp
  REAL (KIND=DBL), ALLOCATABLE, DIMENSION(:,:) :: L

  N1=N
  N2=N+1
  ALLOCATE(y(N1),y0(N1),Lp(N1),L(N1,N2))
  ! initial guess
  DO I=1, N1
    y(I) = cos( (2.0d0*(I-1.0d0)+1.0d0)*4.0d0*atan(1.0d0)/(2.0d0*(N-1.0d0)+2.0d0)  )  &
            + 0.27d0/N1*sin(4.0d0*atan(1.0d0)*(-1.0d0+I*2.0d0/(N1-1.0d0))*(N-1.0d0)/N2 )
    y0(I) = 2.0d0
  ENDDO

  L=0.0d0
  Lp=0.0d0
  ! compute the zeros of the N+1 legendre Polynomial
  ! using the recursion relation and the Newton method
  DO
    L(:,1)=1.0d0
    L(:,2)=y
    DO K=2,N1
      L(:,K+1)=( (2.0d0*K-1.0d0)*y*L(:,K)-(K-1)*L(:,K-1) )/K
    enddo
    Lp=N2*( L(:,N1)-y*L(:,N2) )/(1.0d0-y*y)
    y0=y
    y=y0-L(:,N2)/Lp

    IF (MAXVAL(ABS(y-y0))<1.0d-13) EXIT
  ENDDO

  ! linear map from [-1 1] to [a,b]
  ABSC = ( a*(1.0d0-y)+b*(1.0d0+y) )/2.0d0
  WEIG = N2*N2*(b-a)/( (1.0d0-y*y)*Lp*Lp ) /N1/N1


  DEALLOCATE(y,y0,Lp,L)
  RETURN
	END SUBROUTINE



END MODULE USER_DEFINE_MATH